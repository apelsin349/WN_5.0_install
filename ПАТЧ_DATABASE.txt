# ПАТЧ для lib/database.sh
# Добавить после строки 204 (после "return 1" проверки сервиса):

    ok "PostgreSQL запущен"
    
    # Ожидание готовности PostgreSQL (критично!)
    log_info "Ожидание готовности PostgreSQL после реинициализации..."
    local max_wait=30
    local waited=0
    local connected=false
    
    while [ $waited -lt $max_wait ]; do
        if sudo -u postgres psql -c "SELECT 1" &>/dev/null; then
            connected=true
            ok "PostgreSQL готов к подключению"
            break
        fi
        sleep 2
        ((waited+=2))
        log_debug "  Ожидание... ($waited/$max_wait сек)"
    done
    
    if [ "$connected" = false ]; then
        log_error "PostgreSQL не готов после $max_wait секунд"
        log_error "Проверьте: tail -50 /var/log/postgresql/postgresql-16-main.log"
        return 1
    fi

# Изменить строку 207 (проверка результата):

    # Проверить результат реинициализации (после ожидания!)
    local new_locale=$(sudo -u postgres psql -tAc "SELECT datcollate FROM pg_database WHERE datname='template1'" 2>/dev/null | tr -d ' ')
    
    log_info "Локаль нового кластера: $new_locale"

# КЛЮЧЕВОЕ: Проверять ОБЕ локали (ru_RU.utf8 И ru_RU.UTF-8):

    if [[ "$new_locale" == "ru_RU.utf8" ]] || [[ "$new_locale" == "ru_RU.UTF-8" ]]; then
        ok "✅ Кластер успешно реинициализирован с русской локалью: $new_locale"
        return 0
    else
        log_error "❌ Не удалось реинициализировать кластер с ru_RU.UTF-8"
        log_error "   Текущая локаль: ${new_locale:-пусто (кластер не готов?)}"
        log_error ""
        log_error "Возможные причины:"
        log_error "  1. locale -a не показывает ru_RU (установите: apt install language-pack-ru)"
        log_error "  2. pg_createcluster не смог создать кластер"
        log_error "  3. PostgreSQL не готов (ждем дольше)"
        log_error ""
        return 1
    fi

