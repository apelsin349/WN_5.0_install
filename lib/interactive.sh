#!/bin/bash
# interactive.sh - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
# WorkerNet Installer v5.0

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
select_webserver_interactive() {
    # –ï—Å–ª–∏ —É–∂–µ —É–∫–∞–∑–∞–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
    if [ -n "${WEBSERVER:-}" ]; then
        log_info "–í–µ–±-—Å–µ—Ä–≤–µ—Ä —É–∫–∞–∑–∞–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä: $WEBSERVER"
        return 0
    fi
    
    log_section "üåê –í–´–ë–û–† –í–ï–ë-–°–ï–†–í–ï–†–ê"
    
    echo ""
    log_info "–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
    echo ""
    log_info "  1) Apache"
    log_info "     - –°—Ç–∞–±–∏–ª—å–Ω—ã–π, –ø–æ–ø—É–ª—è—Ä–Ω—ã–π"
    log_info "     - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ .htaccess"
    log_info "     - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤"
    echo ""
    log_info "  2) NGINX"
    log_info "     - –ë—ã—Å—Ç—Ä—ã–π, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π"
    log_info "     - –ú–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏"
    log_info "     - –û—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"
    echo ""
    log_info "  3) –í—ã—Ö–æ–¥"
    echo ""
    
    local choice
    while true; do
        read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ–ø—Ü–∏–∏ (1-3): " choice
        
        case $choice in
            1)
                WEBSERVER="apache"
                ok "–í—ã–±—Ä–∞–Ω –≤–µ–±-—Å–µ—Ä–≤–µ—Ä: Apache"
                break
                ;;
            2)
                WEBSERVER="nginx"
                ok "–í—ã–±—Ä–∞–Ω –≤–µ–±-—Å–µ—Ä–≤–µ—Ä: NGINX"
                break
                ;;
            3)
                log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
                exit 0
                ;;
            *)
                log_warn "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ 1, 2 –∏–ª–∏ 3."
                ;;
        esac
    done
    
    echo ""
    export WEBSERVER
    return 0
}

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –¥–æ–º–µ–Ω–∞
select_domain_interactive() {
    # –ï—Å–ª–∏ —É–∂–µ —É–∫–∞–∑–∞–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
    if [ -n "${DOMAIN:-}" ]; then
        log_info "–î–æ–º–µ–Ω —É–∫–∞–∑–∞–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä: $DOMAIN"
        return 0
    fi
    
    log_section "üè† –ù–ê–°–¢–†–û–ô–ö–ê –î–û–ú–ï–ù–ê"
    
    # –ü–æ–∫–∞–∑–∞—Ç—å IP –∞–¥—Ä–µ—Å–∞
    echo ""
    log_info "IP-–∞–¥—Ä–µ—Å–∞ —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤:"
    local ips=$(ip -4 addr show 2>/dev/null | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '^127\.0\.0\.1$' | head -5)
    if [ -n "$ips" ]; then
        echo "$ips" | while read ip; do
            log_info "  - $ip"
        done
    else
        log_warn "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å IP –∞–¥—Ä–µ—Å–∞"
    fi
    echo ""
    
    log_info "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    echo ""
    log_info "  1) default"
    log_info "     –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
    log_info "     –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: _"
    echo ""
    log_info "  2) custom"
    log_info "     –£–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –∏–ª–∏ IP –∞–¥—Ä–µ—Å"
    echo ""
    log_info "  3) –í—ã—Ö–æ–¥"
    echo ""
    
    local choice
    while true; do
        read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ–ø—Ü–∏–∏ (1-3): " choice
        
        case $choice in
            1)
                DOMAIN="_"
                ok "–í—ã–±—Ä–∞–Ω –¥–æ–º–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: _ (–≤—Å–µ –¥–æ–º–µ–Ω—ã)"
                break
                ;;
            2)
                echo ""
                read -p "–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –∏–ª–∏ IP –∞–¥—Ä–µ—Å: " DOMAIN
                if [ -z "$DOMAIN" ]; then
                    log_warn "–î–æ–º–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
                    continue
                fi
                ok "–í—ã –≤–≤–µ–ª–∏: $DOMAIN"
                break
                ;;
            3)
                log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
                exit 0
                ;;
            *)
                log_warn "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ 1, 2 –∏–ª–∏ 3."
                ;;
        esac
    done
    
    echo ""
    export DOMAIN
    return 0
}

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
confirm_installation_parameters() {
    log_section "üìã –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ü–ê–†–ê–ú–ï–¢–†–û–í"
    
    echo ""
    log_info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    log_info "  –ü–ê–†–ê–ú–ï–¢–†–´ –£–°–¢–ê–ù–û–í–ö–ò:"
    log_info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    log_info "  –í–µ—Ä—Å–∏—è WorkerNet:        $WORKERNET_VERSION"
    log_info "  –ü—Ä–µ—Ñ–∏–∫—Å –º–æ–¥—É–ª–µ–π:         $(get_module_prefix)_*"
    log_info "  –í–µ–±-—Å–µ—Ä–≤–µ—Ä:              ${WEBSERVER:-–Ω–µ —É–∫–∞–∑–∞–Ω}"
    log_info "  –î–æ–º–µ–Ω:                   ${DOMAIN:-–Ω–µ —É–∫–∞–∑–∞–Ω}"
    log_info "  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏:    $INSTALL_DIR"
    log_info "  –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞:    $(get_os_type) $(get_os_version)"
    echo ""
    log_info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo ""
    
    # –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å —ç—Ç–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏? (y/n): " -n 1 -r
    echo ""
    echo ""
    
    if [[ $REPLY =~ ^[Yy–î–¥]$ ]]; then
        ok "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
        echo ""
        return 0
    else
        log_info "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        log_info ""
        log_info "–î–ª—è –Ω–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:"
        log_info "  sudo ./install.sh --version 4.10 --webserver apache --domain example.com"
        log_info ""
        exit 0
    fi
}

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
select_components_interactive() {
    # –ü–æ–∫–∞ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
    # –í –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    
    log_info "–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:"
    log_info "  ‚úì PostgreSQL 16 + PostGIS 3"
    log_info "  ‚úì Redis 7"
    log_info "  ‚úì RabbitMQ 3.x + Erlang"
    log_info "  ‚úì PHP 8.3"
    log_info "  ‚úì Python 3"
    log_info "  ‚úì ${WEBSERVER:-Apache/NGINX}"
    log_info "  ‚úì Supervisor"
    echo ""
    
    return 0
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
setup_interactive() {
    # 1. –í—ã–±–æ—Ä –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤)
    select_webserver_interactive || return 1
    
    # 2. –í—ã–±–æ—Ä –¥–æ–º–µ–Ω–∞ (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤)
    select_domain_interactive || return 1
    
    # 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
    if command -v apply_config_fallbacks &>/dev/null; then
        apply_config_fallbacks
    fi
    
    # 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –∑–∞–¥–∞–Ω—ã
    if [ -z "$WEBSERVER" ]; then
        WEBSERVER="apache"
        log_warn "–í–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: apache"
    fi
    
    if [ -z "$DOMAIN" ]; then
        DOMAIN="_"
        log_warn "–î–æ–º–µ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: _ (–≤—Å–µ –¥–æ–º–µ–Ω—ã)"
    fi
    
    # 5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    confirm_installation_parameters || return 1
    
    return 0
}

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
export -f select_webserver_interactive
export -f select_domain_interactive
export -f confirm_installation_parameters
export -f select_components_interactive
export -f setup_interactive

