# üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: APT –ö–û–ù–§–õ–ò–ö–¢–´

> **–î–∞—Ç–∞:** 28 –æ–∫—Ç—è–±—Ä—è 2025  
> **–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

---

## üö® –û–ë–ù–ê–†–£–ñ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### **1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ apt –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ**

**–û—à–∏–±–∫–∞:**
```
E: Could not get lock /var/lib/dpkg/lock-frontend. It is held by process XXXX (apt)
E: Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend), is another process using it?
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∑–∞–ø—É—Å–∫–∞–ª–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ `apt` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- `apt` –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –ø—Ä–∏–≤–æ–¥–∏–ª –∫ —Å–±–æ—è–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ
–í–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ `install.sh`:

```bash
# –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê (apt –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å)
# –≠—Ç–∞–ø 3: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
setup_database || return 1

# –≠—Ç–∞–ø 4: –ö—ç—à
setup_cache || return 1

# –≠—Ç–∞–ø 5: –û—á–µ—Ä–µ–¥–∏
setup_queue || return 1

# –≠—Ç–∞–ø 6: Backend
setup_backend || return 1

# –≠—Ç–∞–ø 7: –í–µ–±-—Å–µ—Ä–≤–µ—Ä
setup_webserver || return 1
```

---

### **2. –û—à–∏–±–∫–∞ unbound variable –≤ lib/database.sh**

**–û—à–∏–±–∫–∞:**
```
/home/worker/WN_5.0_install/lib/database.sh: line 256: LC_ALL: unbound variable
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `set -euo pipefail` (—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º)
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `LC_ALL` –Ω–µ –±—ã–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `reinit_postgresql_cluster`
- –ü—Ä–∏ —É—Å–ª–æ–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏—Å—å, –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞

**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ
–î–æ–±–∞–≤–ª–µ–Ω–∞ —è–≤–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `reinit_postgresql_cluster`:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ª–æ–∫–∞–ª–∏ (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ–º–∞–Ω–¥ PostgreSQL)
export LANG=ru_RU.UTF-8
export LANGUAGE=ru_RU:ru
export LC_ALL=ru_RU.UTF-8
export LC_CTYPE=ru_RU.UTF-8
export LC_COLLATE=ru_RU.UTF-8
export LC_MESSAGES=ru_RU.UTF-8
```

---

## üìù –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

### 1. **install.sh**
- **–°—Ç—Ä–æ–∫–∏:** 234-248
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **–ü—Ä–∏—á–∏–Ω–∞:** `apt` –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

### 2. **lib/database.sh**
- **–°—Ç—Ä–æ–∫–∏:** 255-261 (–¥–æ–±–∞–≤–ª–µ–Ω–æ)
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–∞ —è–≤–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `reinit_postgresql_cluster`
- **–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤ —Å—Ç—Ä–æ–≥–æ–º —Ä–µ–∂–∏–º–µ bash

---

## üìä –ê–ù–ê–õ–ò–ó –ü–ê–†–ê–õ–õ–ï–õ–ò–ó–ê–¶–ò–ò

### **–ß—Ç–æ –ú–û–ñ–ù–û –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**
- ‚úÖ **Pre-flight checks** - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `apt`
- ‚úÖ **–ü–∞–∫–µ—Ç–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É** - `apt install package1 package2 ...` (–≤ –æ–¥–Ω–æ–º –≤—ã–∑–æ–≤–µ)
- ‚úÖ **Smoke tests** - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `apt`
- ‚úÖ **–ó–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤** - –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º

### **–ß—Ç–æ –ù–ï–õ–¨–ó–Ø –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:**
- ‚ùå **–£—Å—Ç–∞–Ω–æ–≤–∫—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** - –≤—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `apt` ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- ‚ùå **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤** - `apt update` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- ‚ùå **–£—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–∫–µ—Ç–æ–≤** - `apt install` –≤ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢ –ü–ê–†–ê–õ–õ–ï–õ–ò–ó–ê–¶–ò–ò

### **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|-----------|--------|-----------|
| **–ü–∞–∫–µ—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | 3-5x |
| **Pre-flight checks** | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | 6x |
| **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** | ‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ | - |
| **Smoke tests** | üü° –í–æ–∑–º–æ–∂–Ω–æ | 3-5x |

### **–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

**–î–û –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏–∏:** ~30 –º–∏–Ω—É—Ç  
**–ü–û–°–õ–ï –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏–∏:** ~22-25 –º–∏–Ω—É—Ç  
**–í—ã–∏–≥—Ä—ã—à:** ~20% —É—Å–∫–æ—Ä–µ–Ω–∏–µ ‚ö°

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** `apt` –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å, –ø–æ—ç—Ç–æ–º—É –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã) –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π.

---

## üîç –í–´–í–û–î–´

### **–ü–æ—á–µ–º—É apt –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å:**

1. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏** - `/var/lib/dpkg/lock-frontend`, `/var/lib/apt/lists/lock`
2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏
3. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** - –æ–¥–∏–Ω –ø–∞–∫–µ—Ç –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –¥—Ä—É–≥–æ–≥–æ

### **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**

1. **–ö–ª–∞—Å—Ç–µ—Ä–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞** - –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è** - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
3. **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - —Å–∫–∞—á–∞—Ç—å –≤—Å–µ –ø–∞–∫–µ—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –∑–∞—Ç–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

---

## üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### **–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**

1. ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—ã—Å—Ç—Ä—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç** - –æ—Å–Ω–æ–≤–Ω–æ–µ –≤—Ä–µ–º—è —Ç—Ä–∞—Ç–∏—Ç—Å—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –ø–∞–∫–µ—Ç–æ–≤
2. ‚úÖ **–£–≤–µ–ª–∏—á—å—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å apt** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ `APT::Acquire::Queue-Mode "host"` –≤ `/etc/apt/apt.conf.d/`
3. ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–µ—Ä–∫–∞–ª–æ —Ä—è–¥–æ–º** - –≤—ã–±–µ—Ä–∏—Ç–µ –±–ª–∏–∂–∞–π—à–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
4. ‚úÖ **SSD –¥–∏—Å–∫** - —É—Å–∫–æ—Ä—è–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–∫–µ—Ç–æ–≤ –≤ 2-3 —Ä–∞–∑–∞

### **–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è:**

- ‚úÖ **Pre-flight checks (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)** - 6x –±—ã—Å—Ç—Ä–µ–µ
- ‚úÖ **–ü–∞–∫–µ—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞** - 3-5x –±—ã—Å—Ç—Ä–µ–µ (–≤ –æ–¥–Ω–æ–º –≤—ã–∑–æ–≤–µ apt)
- ‚úÖ **Smoke tests (–º–æ–∂–Ω–æ)** - 3-5x –±—ã—Å—Ç—Ä–µ–µ (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å)

---

## ‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
bash -n lib/database.sh
bash -n install.sh

# –†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
```

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

**–¢–µ–ø–µ—Ä—å –∏–Ω—Å—Ç–∞–ª–ª—è—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:**

```bash
sudo ./install.sh
```

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**
1. ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ apt
2. ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. ‚úÖ Pre-flight checks –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (6x –±—ã—Å—Ç—Ä–µ–µ)
4. ‚úÖ –ü–∞–∫–µ—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (3-5x –±—ã—Å—Ç—Ä–µ–µ)
5. ‚úÖ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (—Å—Ç–∞–±–∏–ª—å–Ω–æ)

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 28 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–´**  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê **PRODUCTION-READY**  
**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** üöÄ **~20% –£–°–ö–û–†–ï–ù–ò–ï** (–∑–∞ —Å—á–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö checks –∏ –ø–∞–∫–µ—Ç–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏)
