# 📦 УПРАВЛЕНИЕ ВЕРСИЯМИ WORKERNET

> **Система поддержки множественных версий в улучшенном инсталляторе**

---

## 🎯 ВОЗМОЖНОСТИ

### Поддержка множественных версий

Инсталлятор v5.0 поддерживает:

✅ **Интерактивный выбор** версии при установке  
✅ **Параметр командной строки** --version  
✅ **Расширяемость** - легко добавить новые версии  
✅ **Версионная информация** в логах и выводе  
✅ **Правильные lock-файлы** для каждой версии  

---

## 📋 ПОДДЕРЖИВАЕМЫЕ ВЕРСИИ

### Текущие версии

| Версия | Статус | Описание | Модули |
|--------|--------|----------|--------|
| **3.17** | ✅ Stable | Стабильная версия (Legacy) | usm_* (14 модулей) |
| **4.10** | ✅ Recommended | Текущая стабильная | wnm_* (11 модулей) |
| **5.0** | 🚧 Development | Новая с React | wnm_* (новые) |

### Версия 3.17 (Legacy)

**Особенности:**
- PHP 8.3
- PostgreSQL 15-16
- Python 3.8+
- 14 модулей интеграции
- Префикс модулей: `usm_*`

**Когда использовать:**
- Обновление существующих установок 3.x
- Совместимость со старыми модулями
- Проверенная стабильность

### Версия 4.10 (Рекомендуется)

**Особенности:**
- PHP 8.3
- PostgreSQL 16 + PostGIS 3
- Python 3.9+
- 11 модулей интеграции
- Улучшенный UI
- Префикс модулей: `wnm_*`

**Когда использовать:**
- Новые установки (рекомендуется)
- Современный стек
- Активная поддержка

### Версия 5.0 (В разработке)

**Особенности:**
- React + MUI frontend
- Go microservices (опционально)
- Современный стек
- Префикс модулей: `wnm_*` (новые)

**Когда использовать:**
- Тестирование новых возможностей
- Для разработчиков
- Beta testing

---

## 🚀 ИСПОЛЬЗОВАНИЕ

### Интерактивный выбор (рекомендуется)

```bash
sudo ./install.sh

# Вывод:
════════════════════════════════════════════════════════════════
  ВЫБОР ВЕРСИИ WORKERNET
════════════════════════════════════════════════════════════════

  1) WorkerNet 3.17
     Стабильная версия (Legacy)
     PHP 8.3, PostgreSQL 15-16, Python 3.8+, 14 модулей интеграции

  2) WorkerNet 4.10
     Текущая стабильная (Рекомендуется)
     PHP 8.3, PostgreSQL 16, Python 3.9+, 11 модулей, улучшенный UI

  3) WorkerNet 5.0
     Новая версия с React (В разработке)
     React+MUI frontend, Go microservices (опционально), современный стек


Выберите версию для установки:
1) 3.17 - Стабильная версия (Legacy)
2) 4.10 - Текущая стабильная (Рекомендуется)
3) 5.0 - Новая версия с React (В разработке)
4) Выход

Введите номер версии: 2

✅ Выбрана версия: WorkerNet 4.10
[INFO] Описание: Текущая стабильная (Рекомендуется)
[INFO] Возможности: PHP 8.3, PostgreSQL 16, Python 3.9+, 11 модулей, улучшенный UI

════════════════════════════════════════════════════════════════
ИНФОРМАЦИЯ О ВЕРСИИ
════════════════════════════════════════════════════════════════

  Версия: WorkerNet 4.10
  Описание: Текущая стабильная (Рекомендуется)
  Возможности: PHP 8.3, PostgreSQL 16, Python 3.9+, 11 модулей, улучшенный UI
  Префикс модулей: wnm_*

════════════════════════════════════════════════════════════════
```

---

### С параметром командной строки

```bash
# Установить версию 4.10
sudo ./install.sh --version 4.10

# Установить версию 3.17
sudo ./install.sh --version 3.17

# Установить версию 5.0 (beta)
sudo ./install.sh --version 5.0

# С дополнительными параметрами
sudo ./install.sh --version 4.10 --domain workernet.ru --webserver nginx
```

---

### В конфигурационном файле

```yaml
# install.conf.yml

workernet:
  version: "4.10"    # 3.17, 4.10 или 5.0
  domain: "workernet.example.com"
  webserver: "apache"
```

```bash
sudo ./install.sh --config install.conf.yml
```

---

## 🔧 ВЕРСИОННАЯ ЛОГИКА

### Lock-файлы

Каждая версия создает свой lock-файл:

| Версия | Lock значение |
|--------|---------------|
| 3.17 | `successful-317` |
| 4.10 | `successful-410` |
| 5.0 | `successful-50` |

### Префикс модулей

| Версия | Префикс | Примеры |
|--------|---------|---------|
| 3.17 | `usm_*` | usm_billing, usm_asterisk, usm_checker |
| 4.10 | `wnm_*` | wnm_billing, wnm_asterisk, wnm_checker |
| 5.0 | `wnm_*` | wnm_billing (новые версии модулей) |

### URL загрузки phar

По умолчанию все версии используют:
```
https://bill.workernet.ru:8443/install
```

Для специфичных версий можно настроить в `lib/version.sh`:
```bash
get_phar_url() {
    case $version in
        "3.17") echo "https://bill.workernet.ru:8443/install-317" ;;
        "4.10") echo "https://bill.workernet.ru:8443/install-410" ;;
        "5.0")  echo "https://bill.workernet.ru:8443/install-50" ;;
    esac
}
```

---

## ➕ ДОБАВЛЕНИЕ НОВОЙ ВЕРСИИ

### Пример: Добавить версию 5.1

**1. Обновить lib/version.sh:**

```bash
# Добавить в массив SUPPORTED_VERSIONS
declare -A SUPPORTED_VERSIONS=(
    ["3.17"]="Стабильная версия (Legacy)"
    ["4.10"]="Текущая стабильная (Рекомендуется)"
    ["5.0"]="Новая версия с React"
    ["5.1"]="Обновленная версия 5.0 с исправлениями"  # ← НОВАЯ
)

# Добавить в порядок отображения
VERSION_ORDER=("3.17" "4.10" "5.0" "5.1")  # ← НОВАЯ

# Добавить префикс модулей
declare -A VERSION_MODULE_PREFIX=(
    ["3.17"]="usm"
    ["4.10"]="wnm"
    ["5.0"]="wnm"
    ["5.1"]="wnm"  # ← НОВАЯ
)

# Добавить описание возможностей
declare -A VERSION_FEATURES=(
    ["3.17"]="PHP 8.3, PostgreSQL 15-16, Python 3.8+, 14 модулей"
    ["4.10"]="PHP 8.3, PostgreSQL 16, Python 3.9+, 11 модулей"
    ["5.0"]="React+MUI frontend, Go microservices, современный стек"
    ["5.1"]="React+MUI, Go, улучшенная производительность"  # ← НОВАЯ
)
```

**2. Проверить совместимость (опционально):**

```bash
check_version_compatibility() {
    case $version in
        "5.1")
            # Требования для версии 5.1
            if [ "$os_version" -lt 24 ]; then
                log_error "WorkerNet 5.1 требует Ubuntu 24+, Debian 12+ или AlmaLinux 9+"
                return 1
            fi
            ;;
    esac
}
```

**3. Готово!**

Новая версия 5.1 автоматически появится в меню выбора.

---

## 📊 ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ

### Сценарий 1: Новая установка (4.10)

```bash
$ sudo ./install.sh

# Выбрать опцию 2 (WorkerNet 4.10)

✅ Выбрана версия: WorkerNet 4.10
...
✅ Установка завершена успешно!

[INFO] Установленная версия: WorkerNet 4.10
[INFO] Префикс модулей: wnm_*
```

### Сценарий 2: Legacy установка (3.17)

```bash
$ sudo ./install.sh --version 3.17

✅ Версия предварительно выбрана: 3.17
...
✅ Установка завершена успешно!

[INFO] Установленная версия: WorkerNet 3.17
[INFO] Префикс модулей: usm_*
```

### Сценарий 3: Beta тестирование (5.0)

```bash
$ sudo ./install.sh --version 5.0 --debug

✅ Версия предварительно выбрана: 5.0
⚠️  WorkerNet 5.0 рекомендуется устанавливать на Ubuntu 24+
...
✅ Установка завершена успешно!

[INFO] Установленная версия: WorkerNet 5.0
[INFO] Префикс модулей: wnm_*
```

---

## 🔮 БУДУЩИЕ ВЕРСИИ

### Планируемые версии

| Версия | Дата | Описание |
|--------|------|----------|
| 5.0 | Q1 2026 | React frontend, Go backend |
| 5.1 | Q2 2026 | Улучшения производительности |
| 6.0 | Q4 2026 | Kubernetes native, microservices |

### Автоматическая поддержка

Когда выходит новая версия:

1. ✅ Обновить `lib/version.sh` (5 строк)
2. ✅ Опубликовать phar файл
3. ✅ Готово! Версия доступна в инсталляторе

**Не нужно переписывать код установки!**

---

## 📝 API ВЕРСИЙ

### Функции (lib/version.sh)

```bash
# Выбор версии интерактивно или из параметра
setup_version

# Показать информацию о версии
show_version_info

# Получить префикс модулей (usm/wnm)
get_module_prefix "$version"

# Получить lock-значение (successful-317/410/50)
get_lock_value "$version"

# Получить URL для загрузки phar
get_phar_url "$version"

# Проверить поддержку версии
is_version_supported "$version"

# Проверить совместимость с ОС
check_version_compatibility "$version"

# Зарегистрировать новую версию (программно)
register_version "5.1" "Обновленная версия 5.0" "React+MUI, Go, улучшения" "wnm"
```

---

## ✨ ПРЕИМУЩЕСТВА

### Для администраторов

✅ **Выбор версии** при установке  
✅ **Понятные описания** каждой версии  
✅ **Рекомендации** какую версию выбрать  
✅ **Информация о возможностях** каждой версии  

### Для разработчиков

✅ **Легко добавить** новую версию (5 строк)  
✅ **Версионная логика** централизована  
✅ **Расширяемая архитектура**  
✅ **Не нужно дублировать** код установки  

---

## 🎭 ПРИМЕР ВЫВОДА

### Интерактивный выбор

```bash
$ sudo ./install.sh

__          __        _             _   _      _
\ \        / /       | |           | \ | |    | |
 \ \  /\  / /__  _ __| | _____ _ __|  \| | ___| |_
  \ \/  \/ / _ \| '__| |/ / _ \ '__| . ` |/ _ \ __|
   \  /\  / (_) | |  |   <  __/ |  | |\  |  __/ |_
    \/  \/ \___/|_|  |_|\_\___|_|  |_| \_|\___|\__|

    Installer v5.0 - Улучшенная версия

════════════════════════════════════════════════════════════════

[INFO] ════════════════════════════════════════════════════════════════════════
[INFO]   ВЫБОР ВЕРСИИ WORKERNET
[INFO] ════════════════════════════════════════════════════════════════════════

  1) WorkerNet 3.17
     Стабильная версия (Legacy)
     PHP 8.3, PostgreSQL 15-16, Python 3.8+, 14 модулей интеграции

  2) WorkerNet 4.10
     Текущая стабильная (Рекомендуется)
     PHP 8.3, PostgreSQL 16, Python 3.9+, 11 модулей, улучшенный UI

  3) WorkerNet 5.0
     Новая версия с React (В разработке)
     React+MUI frontend, Go microservices (опционально), современный стек


[INFO] Выберите версию для установки:

1) 3.17 - Стабильная версия (Legacy)
2) 4.10 - Текущая стабильная (Рекомендуется)
3) 5.0 - Новая версия с React (В разработке)
4) Выход

Введите номер версии: 2

✅ Выбрана версия: WorkerNet 4.10
[INFO] Описание: Текущая стабильная (Рекомендуется)
[INFO] Возможности: PHP 8.3, PostgreSQL 16, Python 3.9+, 11 модулей, улучшенный UI

════════════════════════════════════════════════════════════════
ИНФОРМАЦИЯ О ВЕРСИИ
════════════════════════════════════════════════════════════════

  Версия: WorkerNet 4.10
  Описание: Текущая стабильная (Рекомендуется)
  Возможности: PHP 8.3, PostgreSQL 16, Python 3.9+, 11 модулей, улучшенный UI
  Префикс модулей: wnm_*

════════════════════════════════════════════════════════════════

# Продолжается установка...
```

---

### С параметром --version

```bash
$ sudo ./install.sh --version 4.10

✅ Версия предварительно выбрана: 4.10

════════════════════════════════════════════════════════════════
ИНФОРМАЦИЯ О ВЕРСИИ
════════════════════════════════════════════════════════════════

  Версия: WorkerNet 4.10
  Описание: Текущая стабильная (Рекомендуется)
  Возможности: PHP 8.3, PostgreSQL 16, Python 3.9+, 11 модулей, улучшенный UI
  Префикс модулей: wnm_*

════════════════════════════════════════════════════════════════

# Продолжается установка...
```

---

### В конце установки

```
╔════════════════════════════════════════════════════════════════╗
║              🔑 ПАРАМЕТРЫ УСТАНОВКИ                            ║
╚════════════════════════════════════════════════════════════════╝

════════════════════════════════════════════════════════════════
  УСТАНОВЛЕННАЯ ВЕРСИЯ: WorkerNet 4.10
  Префикс модулей: wnm_*
────────────────────────────────────────────────────────────────
  PostgreSQL database name: workernet
  PostgreSQL username: root
  PostgreSQL password: xK9pL2mN5vQ7w
  ...
════════════════════════════════════════════════════════════════

✅ Установка завершена успешно!

[INFO] Установленная версия: WorkerNet 4.10
[INFO] Префикс модулей: wnm_*
```

---

## 🛠️ РАСШИРЕНИЕ СИСТЕМЫ

### Добавление версии 6.0 (будущее)

**Просто добавить в `lib/version.sh`:**

```bash
declare -A SUPPORTED_VERSIONS=(
    ["3.17"]="Стабильная версия (Legacy)"
    ["4.10"]="Текущая стабильная"
    ["5.0"]="Новая версия с React"
    ["5.1"]="Обновленная версия 5.0"
    ["6.0"]="Kubernetes native"  # ← НОВАЯ ВЕРСИЯ
)

VERSION_ORDER=("3.17" "4.10" "5.0" "5.1" "6.0")  # ← Добавить

declare -A VERSION_MODULE_PREFIX=(
    # ...
    ["6.0"]="wnm"  # ← Добавить
)

declare -A VERSION_FEATURES=(
    # ...
    ["6.0"]="Kubernetes, микросервисы, облачный native"  # ← Добавить
)
```

**Готово!** Версия 6.0 автоматически появится в меню.

---

## ✅ ПРЕИМУЩЕСТВА ПОДХОДА

### vs хардкод версии

**Было (хардкод):**
```bash
# Нужно менять код для каждой новой версии
WORKERNET_VERSION="4.10"
echo "successful-410" > lock_file
```

**Стало (динамическое):**
```bash
# Выбор версии
setup_version

# Автоматическое определение параметров
get_lock_value "$WORKERNET_VERSION"    # → "successful-410"
get_module_prefix "$WORKERNET_VERSION"  # → "wnm"
get_phar_url "$WORKERNET_VERSION"       # → URL
```

### Результат

✅ **Одна кодовая база** для всех версий  
✅ **Легко добавлять** новые версии  
✅ **Пользователь выбирает** нужную версию  
✅ **Расширяемость** для будущего  
✅ **Меньше дублирования** кода  

---

## 📋 СРАВНЕНИЕ С ОРИГИНАЛОМ

### Оригинальный инсталятор

```bash
# workernet.online/download/release/ubuntu/24/ubuntu-24.sh

options=(
    "Установка WorkerNet 3.17"
    "Настройка после установки WorkerNet 3.17"
    "Установка модулей WorkerNet 3.17"
    "Установка WorkerNet 4.1"
    "Настройка после установки WorkerNet 4.1"
    "Установка зависимостей модулей WorkerNet 4.1"
    "Выход"
)

# 6 пунктов меню для 2 версий = дублирование
```

### Улучшенный инсталятор v5.0

```bash
# lib/version.sh

# Одно меню для выбора версии
select_version_interactive

# Единая логика установки
install.sh
```

**Результат:**
- Меньше дублирования
- Проще добавлять версии
- Чище код

---

## ✨ ЗАКЛЮЧЕНИЕ

**Система управления версиями добавлена!**

✅ **Интерактивный выбор** из 3 версий (3.17, 4.10, 5.0)  
✅ **Параметр --version** для автоматизации  
✅ **Расширяемость** - легко добавить версию 5.1, 6.0 и т.д.  
✅ **Версионная информация** в логах  
✅ **Правильные lock-файлы** для каждой версии  
✅ **Русскоязычный интерфейс** выбора  

**Инсталлятор готов к будущим версиям WorkerNet! 🚀**

---

**Создано:** 23 октября 2025  
**Версия:** 1.0  
**Статус:** ✅ Полностью реализовано

